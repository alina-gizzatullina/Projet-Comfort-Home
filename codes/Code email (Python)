# ============================================================================
# ğŸ Ce script est Ã©crit en Python, PAS pour Arduino !
# Il NE DOIT PAS Ãªtre utilisÃ© dans l'IDE Arduino.
#
# ğŸ“¦ Utilisation :
# 1. TÃ©lÃ©versez d'abord le Code initial (Arduino) sur votre carte (UCA board)
# 2. Fermez le Moniteur sÃ©rie de l'IDE Arduino
# 3. Ã€ la ligne 29, oÃ¹ il est Ã©crit email_destinatoire="", insÃ©rez votre email.
# 4. Lancez ce script Python dans Thonny (ou tout autre Ã©diteur Python)
#
# âœ‰ï¸ Ce script envoie des alertes par email via SMTP
# avec un intervalle minimum de 30 minutes entre les messages identiques.
# ============================================================================

import serial
import smtplib
import time
import re
from email.message import EmailMessage

# === ParamÃ¨tres ===
port_serie    = "COM3"  # Modifie selon le port de ta carte
baud_rate     = 115200
INTERVAL_MIN  = 1800  # 30 minutes en secondes

# === Configuration de l'email ===
email_expediteur = "yekaterina.kirpichova@gmail.com"
mot_de_passe_app = "dmrb byfa aqxc jlsv"
email_destinataire = ""

# === Variables d'Ã©tat ===
dernier_message = ""
dernier_envoi = 0

# === Connexion sÃ©rie ===
print(f"â†’ Connexion au port {port_serie}â€¦")
try:
    ser = serial.Serial(port_serie, baud_rate, timeout=1)
    time.sleep(2)
    print("âœ” Port sÃ©rie ouvert.")
except Exception as e:
    print("âŒ Erreur port sÃ©rie :", e)
    exit(1)

# === Fonction d'envoi d'email ===
def envoyer_email(sujet, corps):
    msg = EmailMessage()
    msg["Subject"] = sujet
    msg["From"] = email_expediteur
    msg["To"] = email_destinataire
    msg.set_content(corps)

    try:
        with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp:
            smtp.login(email_expediteur, mot_de_passe_app)
            smtp.send_message(msg)
        print("ğŸ“¨ Email envoyÃ© :", sujet)
    except Exception as e:
        print("âŒ Erreur d'envoi email :", e)

# === Boucle principale ===
print("ğŸ” En attente des alertes Arduino...")
while True:
    try:
        if ser.in_waiting:
            ligne = ser.readline().decode(errors='ignore').strip()
            if ligne.startswith("[ALERTE]"):
                parties = ligne.replace("[ALERTE]", "").strip().split("|")
                alerte = parties[0].strip()
                temp = hum = lux = None

                for p in parties[1:]:
                    if "temp=" in p:
                        temp = float(re.findall(r"[-+]?\d*\.\d+|\d+", p)[0])
                    elif "hum=" in p:
                        hum = float(re.findall(r"[-+]?\d*\.\d+|\d+", p)[0])
                    elif "lux=" in p:
                        lux = float(re.findall(r"[-+]?\d*\.\d+|\d+", p)[0])

                maintenant = time.time()
                if alerte != dernier_message or (maintenant - dernier_envoi > INTERVAL_MIN):
                    # Corps du mail avec gestion de None
                    corps = f"Alerte Domotique ğŸš¨\n\nğŸ”¸ Message : {alerte}\n"
                    if temp is not None:
                        corps += f"ğŸŒ¡ TempÃ©rature : {temp:.1f} Â°C\n"
                    if hum is not None:
                        corps += f"ğŸ’§ HumiditÃ© : {hum:.1f} %\n"
                    if lux is not None:
                        corps += f"ğŸ”† LuminositÃ© : {lux:.0f} lux\n"
                    corps += "\nCette alerte a Ã©tÃ© envoyÃ©e automatiquement."

                    envoyer_email("âš ï¸ Alerte Domotique", corps)
                    dernier_message = alerte
                    dernier_envoi = maintenant
                else:
                    print("â³ Alerte ignorÃ©e (anti-spam actif)")
    except Exception as e:
        print("âŒ Erreur de lecture :", e)
        time.sleep(1)
