#include <Wire.h>
#include <Adafruit_SHTC3.h>
#include <Adafruit_LTR390.h>
#include <RH_RF95.h>
#include "lcdgfx.h"

// --- OLED через lcdgfx ---
DisplaySSD1306_128x64_I2C display(-1);

// --- Датчики ---
Adafruit_SHTC3 shtc3;
Adafruit_LTR390 ltr;

// --- LoRa ---
RH_RF95 rf95(10, 3);  // CS=10, INT=3

// --- Пороги ---
#define MIN_HUMIDITY 40
#define MAX_HUMIDITY 70
#define MIN_TEMP 18
#define MAX_TEMP 26
#define LUX_THRESHOLD 50

void setup() {
  Serial.begin(9600);
  Wire.begin();

  // Инициализация OLED
  display.begin();
  display.setFixedFont(ssd1306xled_font6x8);
  display.clear();
  display.printFixed(0, 0, "OLED ready", STYLE_NORMAL);

  // Инициализация датчиков
  if (!shtc3.begin()) {
    Serial.println("Ошибка SHTC3");
    display.printFixed(0, 10, "Err: SHTC3", STYLE_BOLD);
  }

  if (!ltr.begin()) {
    Serial.println("Ошибка LTR390");
    display.printFixed(0, 20, "Err: LTR390", STYLE_BOLD);
  } else {
    ltr.setMode(LTR390_MODE_ALS);
  }

  // Инициализация LoRa
  if (!rf95.init()) {
    Serial.println("Ошибка LoRa");
    display.printFixed(0, 30, "Err: LoRa", STYLE_BOLD);
  } else {
    rf95.setFrequency(868.0);
    display.printFixed(0, 40, "LoRa OK", STYLE_NORMAL);
  }

  delay(2000);
  display.clear();
}

void loop() {
  sensors_event_t humidity, temp;
  shtc3.getEvent(&humidity, &temp);
  float currentTemp = temp.temperature;
  float currentHumidity = humidity.relative_humidity;
  float lux = ltr.readALS();

  displayData(currentTemp, currentHumidity, lux);
  checkAndSendAlerts(currentTemp, currentHumidity, lux);

  delay(3000);
}

void displayData(float temp, float humidity, float lux) {
  display.clear();
  char buffer[32];

  snprintf(buffer, sizeof(buffer), "Temp: %.1f C", temp);
  display.printFixed(0, 0, buffer, STYLE_NORMAL);

  snprintf(buffer, sizeof(buffer), "Hum : %.1f %%", humidity);
  display.printFixed(0, 10, buffer, STYLE_NORMAL);

  snprintf(buffer, sizeof(buffer), "Lux : %.0f lx", lux);
  display.printFixed(0, 20, buffer, STYLE_NORMAL);
}

void checkAndSendAlerts(float temp, float humidity, float lux) {
  if (humidity < MIN_HUMIDITY) {
    sendLoRaAlert("Включите увлажнитель!");
  } else if (humidity > MAX_HUMIDITY) {
    sendLoRaAlert("Включите осушитель!");
  }

  if (temp < MIN_TEMP) {
    sendLoRaAlert("Включите обогреватель!");
  } else if (temp > MAX_TEMP) {
    sendLoRaAlert("Включите кондиционер!");
  }

  if (lux < LUX_THRESHOLD) {
    sendLoRaAlert("Включите люстру!");
  }
}

void sendLoRaAlert(const char* message) {
  rf95.send((uint8_t*)message, strlen(message));
  rf95.waitPacketSent();
  Serial.println("Отправлено: " + String(message));
}
